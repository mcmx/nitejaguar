# Project Nitejaguar

Workflow automation written in Go

A standalone or client/server workflow automation application.


## Getting Started

These instructions will get you a copy of the project up and running on your local machine for development and testing purposes. See deployment for notes on how to deploy the project on a live system.

### Server mode
To start the application in server mode, you need to define some environment variables in a `.env` file:

```txt
PORT=8081  # if not set, 8080 will be used by default
DB_URL=file:./test.db?_fk=1&cache=shared
```

The only required value is DB_URL for server mode, if not defined you will receive the following message:
`
DB_URL is empty, you could set it to: file:ent.db?mode=memory&cache=shared&_fk=1, to start in memory only
`

Note that if using the recommended value any change will be lost after the application is shut.

To start the server:

`./nitejaguar server`

Now you can access the web page at the port.

Or the API at /api

Logs are stored at `./log/server.log`
Results are stored at `./results/`

At the moment, only workflows JSON definitions are stored in the database in the workflows table.
With time also results will be stored in the database in a separate table, with a respective job to clear old results.

## API

Check out the API documentation at:

http://127.0.0.1:8081/docs

### Client mode
(Work in progress)

When running on client mode, you need to provide a server address and credentials either through
command line arguments or environmental variables

## Workflows

Workflows are stored in the workflows table in the database, currently we have the following fields:
id|enabled|json_definition|created_at|updated_at

The workflow json_definition is as follows:
id: string
name:string
nodes: hash

node: {
    id: string
    name: string
    description: string
    action_type: string [trigger|action]
    action_name: string
    arguments: hash (check each action or trigger for the arguments)
    conditions: hash
    dependencies: list
}

json schema (auto generated by copilot haven't been verified):
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Workflow",
  "type": "object",
  "required": ["id", "name", "nodes"],
  "properties": {
    "id": { "type": "string" },
    "name": { "type": "string" },
    "nodes": {
      "type": "object",
      "patternProperties": {
        "^.*$": {
          "type": "object",
          "required": ["id", "name", "description", "action_type", "action_name", "arguments", "conditions"],
          "properties": {
            "id": { "type": "string" },
            "name": { "type": "string" },
            "description": { "type": "string" },
            "action_type": { "type": "string", "enum": ["action", "trigger"] },
            "action_name": { "type": "string" },
            "arguments": {
              "type": "object",
              "additionalProperties": true
            },
            "conditions": {
              "type": "object",
              "properties": {
                "entries": {
                  "type": "object",
                  "patternProperties": {
                    "^.*$": {
                      "type": "object",
                      "required": ["condition", "nexts"],
                      "properties": {
                        "condition": {
                          "type": "object",
                          "required": ["leftOperand", "operator", "rightOperand"],
                          "properties": {
                            "leftOperand": {},
                            "operator": { "type": "string" },
                            "rightOperand": {}
                          }
                        },
                        "nexts": {
                          "type": "array",
                          "items": { "type": "string" }
                        }
                      }
                    }
                  }
                }
              }
            },
            "dependencies": {
              "anyOf": [
                { "type": "array", "items": { "type": "string" } },
                { "type": "null" }
              ]
            }
          }
        }
      }
    }
  }
}
```



## Triggers and Actions

## Inner architecture

All ID's are typeid based on uuid, it provides a sortable time based id with the following prefixes used:
- workflow, indicates a workflow id
- result, indicates this is a result id
- action, indicates this is an action id
- trigger, indicates this is a trigger id

Having these ID's allows us to export/import a complete workflow from one instance to another without errors.
Also it allows the operator to very easily identify the entities, and for the results it makes it very easy to
sort by creation creation date (you can't get the date and time from the id) but you know it's in a chronological order.

## MakeFile

Run build make command with tests
```bash
make all
```

Build the application
```bash
make build
```

Run the application
```bash
make run
```

Live reload the application:
```bash
make watch
```

Run the test suite:
```bash
make test
```

Clean up binary from the last build:
```bash
make clean
```
